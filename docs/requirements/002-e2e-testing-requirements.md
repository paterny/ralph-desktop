# Ralph Desktop 端到端测试需求文档

**版本**: 0.1.0
**创建日期**: 2026-01-31
**状态**: 待确认

---

## 目录

1. [需求概述](#1-需求概述)
2. [需求详情](#2-需求详情)
   - [2.1 自动化端到端测试（开发态）](#21-自动化端到端测试开发态)
   - [2.2 Codex 与 Claude Code 覆盖](#22-codex-与-claude-code-覆盖)
   - [2.3 测试脚本纳入源码管理](#23-测试脚本纳入源码管理)
3. [验收标准](#3-验收标准)
4. [技术实现要点](#4-技术实现要点)
5. [待确认事项](#5-待确认事项)
6. [测试环境要求（新增）](#6-测试环境要求新增)
7. [调试与报告（新增）](#7-调试与报告新增)

---

## 1. 需求概述

本需求旨在为 Ralph Desktop 增加**可重复、无人值守**的端到端 UI 自动化测试（开发态），
覆盖核心流程并支持 Codex/Claude Code 两种 CLI 跑通。

| 编号 | 需求 | 优先级 |
|------|------|--------|
| REQ-008 | 开发态端到端 UI 自动化测试 | P0 |
| REQ-009 | Codex/Claude Code 双 CLI 覆盖 | P0 |
| REQ-010 | 测试脚本纳入源码管理 | P0 |

---

## 2. 需求详情

### 2.1 自动化端到端测试（开发态）

**需求编号**: REQ-008

#### 描述
在 `pnpm tauri dev` 开发态下，通过自动化工具驱动 UI，完成从创建项目、Brainstorm、执行任务、查看日志、完成状态等端到端流程。

#### 目标流程（最小可行）
1. 启动应用（开发态）
2. 创建新项目（选择临时目录）
3. 进入 AI Brainstorm
4. 以简短输入完成 Brainstorm（无需人工选择，自动选择）
5. 启动执行，等待完成或迭代达到上限
6. 校验完成状态与输出日志

#### 超时与重试策略
- 每个关键步骤需要明确超时上限（建议初始值）：
  - 启动应用：60s
  - Brainstorm：120s（可配置）
  - 执行任务：5-10min（可配置）
- 失败重试策略：
  - 允许对 **单个用例**进行 1 次重试
  - 对波动用例标记为 flaky（需在报告中体现）

#### 输入示例
- “写一个与众不同的贪吃蛇”
- “写一个与众不同的俄罗斯方块”

#### 技术栈倾向
- 自动化流程中，若出现技术栈选择，**优先选择 Web 技术（HTML5 Canvas / JavaScript）**，便于验证输出产物。

#### 通过判定（最低标准）
- 生成至少一个可运行的 HTML/JS 输出文件
- 日志中出现 completion signal 或状态为 Completed
- 若达到 maxIterations，必须记录为 **已达上限** 并可被识别为可接受的结束状态

---

### 2.2 Codex 与 Claude Code 覆盖

**需求编号**: REQ-009

#### 描述
同一套端到端测试流程需支持 Codex 与 Claude Code 两种 CLI，确保在不同 CLI 下均能完成执行链路。

#### 要求
- 自动检测 CLI 可用性
- 允许通过参数指定运行 CLI 类型（claude / codex）
- 若 CLI 不可用，可跳过该组用例但必须提示原因
- CLI 不可用时：测试进程仍应返回成功（但报告中标注 SKIPPED）

---

### 2.3 测试脚本纳入源码管理

**需求编号**: REQ-010

#### 描述
所有端到端测试脚本必须存入代码仓库，保证团队可复用、可持续执行。

#### 要求
- 测试脚本置于 `tests/` 或 `scripts/` 目录
- 提供统一入口命令（如 `pnpm test:e2e`）
- 文档记录运行方法与环境要求
- 需要支持单个用例执行与调试模式（headful/slow-mo）

---

## 3. 验收标准

- [ ] 在开发态下可自动完成“创建项目 → Brainstorm → 执行 → 完成”主流程
- [ ] 支持 Codex / Claude Code 作为 CLI 执行入口
- [ ] 测试脚本已纳入 Git 管理并可一键运行
- [ ] 测试产物（临时项目目录、输出日志）可被自动清理
- [ ] 测试报告输出可被机器读取（JSON/HTML 之一）

---

## 4. 技术实现要点

- UI 自动化优先使用 Playwright（本地驱动 UI）
- 需要保证测试不被“中途提问”阻塞
- 测试应支持长时间运行（允许任务耗时较长）
- 建议引入“测试模式”配置（例如固定迭代次数、固定 prompt、限制并发）
- 支持可配置 maxIterations（建议 5-10 以提高稳定性）
- 测试数据隔离：临时目录需按时间戳/UUID 命名，并在用例结束后清理
- 并行执行策略：默认串行，后续可开启并行但需确保目录与端口隔离
- 测试报告：输出到 `./artifacts/e2e/`（含日志与结果）
- 环境要求需写明（Node 版本、OS、CLI API Key、网络要求）
- 对 AI 输出不确定性：只验证最低通过条件，不比较文本内容

---

## 5. 待确认事项

- 是否需要在 CI 中运行端到端测试（默认仅本地执行）
- 是否需要覆盖“暂停 / 恢复 / 停止”按钮的自动化流程

---

## 6. 测试环境要求（新增）

- Node.js 版本：>= 18
- pnpm 版本：>= 8
- 运行平台：macOS（开发态）
- 需要安装并配置 Claude Code / Codex
- API Key / 登录态需在测试前准备好

---

## 7. 调试与报告（新增）

- 支持调试模式（headful + slowMo）
- 支持只跑单个用例（如 `pnpm test:e2e -- --grep snake`）
- 报告输出位置：`./artifacts/e2e/`
